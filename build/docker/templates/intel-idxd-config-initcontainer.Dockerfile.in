FROM debian:stable as build
RUN apt-get update && apt-get install -y --no-install-recommends accel-config jq curl ca-certificates make libc6-dev && rm -rf /var/lib/apt/lists/\*
RUN mkdir -p /idxd-init/scratch

ARG DIR=/intel-device-plugins-for-kubernetes
WORKDIR ${DIR}
COPY . .

#include "toybox_build.docker"

ARG LIBS="libjson-c libaccel-config libjq libtinfo libonig"
ARG EXECS="accel-config jq"
ARG LICENSES="jq libjq1 libjson-c5 libaccel-config1 libonig5 libtinfo6"

RUN mkdir /tmp/libs && for l in ${LIBS}; do cp "/lib/x86_64-linux-gnu/${l}.so"* /tmp/libs/; done
RUN mkdir /tmp/bins && for b in ${EXECS}; do cp "/usr/bin/${b}" /tmp/bins/; done
RUN mkdir /tmp/licenses && for l in ${LICENSES}; do cp -r "/usr/share/doc/${l}" /tmp/licenses/; done

FROM gcr.io/distroless/cc

COPY ./LICENSE /licenses/intel-device-plugins-for-kubernetes/LICENSE

COPY demo/idxd-init.sh /usr/local/bin/
COPY demo/dsa.conf /idxd-init/
COPY demo/iaa.conf /idxd-init/

COPY --from=build /idxd-init /idxd-init
COPY --from=build /install_root /
COPY --from=build /tmp/bins//* /usr/bin/
COPY --from=build /tmp/libs//* /lib/x86_64-linux-gnu/
COPY --from=build /tmp/licenses/ /usr/share/doc/

WORKDIR /idxd-init
ENTRYPOINT ["/usr/local/bin/idxd-init.sh"]
