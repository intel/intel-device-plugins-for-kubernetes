#define _ENTRYPOINT_ /usr/local/bin/intel_gpu_levelzero

ARG CMD=gpu_levelzero
ARG BUILD_BASE=golang:1.25-trixie

FROM ${BUILD_BASE} AS builder

ARG DIR=/intel-device-plugins-for-kubernetes

ENV CGO_CFLAGS="-pipe -fno-plt"
ENV CGO_LDFLAGS="-fstack-protector-strong -Wl,-O1,--sort-common,--as-needed,-z,relro,-z,now,-z,noexecstack,-z,defs,-s,-w"
ENV CGOFLAGS="-trimpath -mod=readonly -buildmode=pie"
ENV GCFLAGS="all=-spectre=all -N -l"
ENV ASMFLAGS="all=-spectre=all"
ENV LDFLAGS="all=-linkmode=external -s -w"

ARG GOLICENSES_VERSION
ARG CMD

RUN mkdir /runtime

RUN apt-get update && apt-get install --no-install-recommends -y jq libc6-dev ocl-icd-libopencl1 gcc ca-certificates && \N
    cd /runtime && \N
    curl -sSLO https://github.com/intel/intel-graphics-compiler/releases/download/v2.20.3/intel-igc-core-2_2.20.3+19972_amd64.deb && \N
    curl -sSLO https://github.com/intel/intel-graphics-compiler/releases/download/v2.20.3/intel-igc-opencl-2_2.20.3+19972_amd64.deb && \N
    curl -sSLO https://github.com/intel/compute-runtime/releases/download/25.40.35563.4/intel-opencl-icd_25.40.35563.4-0_amd64.deb && \N
    curl -sSLO https://github.com/intel/compute-runtime/releases/download/25.40.35563.4/libigdgmm12_22.8.2_amd64.deb && \N
    curl -sSLO https://github.com/intel/compute-runtime/releases/download/25.40.35563.4/libze-intel-gpu1_25.40.35563.4-0_amd64.deb && \N
    curl -sSLO https://github.com/oneapi-src/level-zero/releases/download/v1.24.3/level-zero_1.24.3+u22.04_amd64.deb && \N
    curl -sSLO https://github.com/oneapi-src/level-zero/releases/download/v1.24.3/level-zero-devel_1.24.3+u22.04_amd64.deb && \N
    dpkg -i *.deb && \N
    rm -f *.deb && \N
    rm -rf /var/lib/apt/lists/\*

ARG EP=_ENTRYPOINT_

WORKDIR ${DIR}
COPY . .

RUN cd cmd/${CMD} && \N
    GO111MODULE=on CGO_ENABLED=1 go install $CGOFLAGS --gcflags="$GCFLAGS" --asmflags="$ASMFLAGS" --ldflags="$LDFLAGS" && \N
    install -D /go/bin/${CMD} /install_root${EP}

#include "default_licenses.docker"

FROM debian:unstable-slim

ARG CMD

COPY --from=builder /runtime /runtime

RUN apt-get update && apt-get install --no-install-recommends -y ocl-icd-libopencl1 curl ca-certificates && \N
    cd /runtime && \N
    curl -sSLO https://github.com/intel/intel-graphics-compiler/releases/download/v2.20.3/intel-igc-core-2_2.20.3+19972_amd64.deb && \N
    curl -sSLO https://github.com/intel/intel-graphics-compiler/releases/download/v2.20.3/intel-igc-opencl-2_2.20.3+19972_amd64.deb && \N
    curl -sSLO https://github.com/intel/compute-runtime/releases/download/25.40.35563.4/intel-opencl-icd_25.40.35563.4-0_amd64.deb && \N
    curl -sSLO https://github.com/intel/compute-runtime/releases/download/25.40.35563.4/libigdgmm12_22.8.2_amd64.deb && \N
    curl -sSLO https://github.com/intel/compute-runtime/releases/download/25.40.35563.4/libze-intel-gpu1_25.40.35563.4-0_amd64.deb && \N
    curl -sSLO https://github.com/oneapi-src/level-zero/releases/download/v1.24.3/level-zero_1.24.3+u22.04_amd64.deb && \N
    dpkg -i *.deb && \N
    apt-get -y remove ca-certificates && \N
    apt-get -y autoremove && \N
    rm -f *.deb && \N
    rm -rf /var/lib/apt/lists/\* && \N
    rm "/lib/x86_64-linux-gnu/libze_validation"* && rm "/lib/x86_64-linux-gnu/libze_tracing_layer"*

#include "default_end.docker"
#include "default_labels.docker"

LABEL name='intel-gpu-levelzero'
LABEL summary='IntelÂ® GPU levelzero for Kubernetes'
LABEL description='The GPU levelzero container provides access to Levelzero API for the Intel GPU plugin'
